name: 'Perf: Persist PR Audit'

on:
  workflow_run:
    workflows: ['Perf: Audit']
    types: [completed]

env:
  PERF_AUDIT_REPO: misty-step/vox-perf-audit

jobs:
  persist:
    name: Persist PR Perf JSON
    if: github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Perf Artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RUN_ID="${{ github.event.workflow_run.id }}"

          ART_ID="$(gh api \
            "repos/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}/artifacts" \
            --jq '.artifacts[] | select(.name | startswith("perf-audit-pr-")) | .id' \
            2>/dev/null | head -1 || true)"

          if [ -z "$ART_ID" ]; then
            echo "No perf-audit-pr-* artifact found."
            exit 0
          fi

          gh api "repos/${GITHUB_REPOSITORY}/actions/artifacts/${ART_ID}/zip" > artifact.zip
          unzip -q artifact.zip -d artifact

          HEAD_JSON="$(find artifact -name head.json | head -1 || true)"
          HEAD_CODEPATH_JSON="$(find artifact -name head-codepath.json | head -1 || true)"
          META_JSON="${HEAD_JSON:-$HEAD_CODEPATH_JSON}"

          if [ -z "$META_JSON" ]; then
            echo "No perf head JSON in artifact (audit likely skipped)."
            exit 0
          fi

          echo "HEAD_JSON=$HEAD_JSON" >> "$GITHUB_ENV"
          echo "HEAD_CODEPATH_JSON=$HEAD_CODEPATH_JSON" >> "$GITHUB_ENV"
          echo "META_JSON=$META_JSON" >> "$GITHUB_ENV"

      - name: Persist To vox-perf-audit
        env:
          GH_TOKEN: ${{ secrets.PERF_AUDIT_TOKEN }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail

          if [ -z "${META_JSON:-}" ]; then
            echo "META_JSON unset; skipping."
            exit 0
          fi

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "PERF_AUDIT_TOKEN not set; skipping persist to vox-perf-audit."
            exit 0
          fi

          if [ -z "${PR_NUMBER:-}" ] || [ -z "${SHA:-}" ]; then
            echo "Missing PR_NUMBER/SHA from workflow_run event; skipping."
            exit 0
          fi
          if ! printf '%s' "$PR_NUMBER" | grep -Eq '^[0-9]+$'; then
            echo "Invalid PR_NUMBER from workflow_run event; skipping."
            exit 0
          fi
          if ! printf '%s' "$SHA" | grep -Eq '^[0-9a-fA-F]{40}$'; then
            echo "Invalid SHA from workflow_run event; skipping."
            exit 0
          fi
          SHA="$(printf '%s' "$SHA" | tr '[:upper:]' '[:lower:]')"

          AUDIT_REPO="${PERF_AUDIT_REPO}"
          ADDED=0

          upload_file() {
            local src="$1"
            local dest_path="$2"
            local msg="$3"
            local content http_out payload
            if gh api "repos/${AUDIT_REPO}/contents/${dest_path}" >/dev/null 2>&1; then
              echo "Already exists: ${dest_path} — skipping."
              return 0
            fi
            content="$(base64 < "$src" | tr -d '\n')"
            payload="$(mktemp "${RUNNER_TEMP:-/tmp}/vox-perf-upload.XXXXXX.json")"
            jq -n \
              --arg message "$msg" \
              --arg content "$content" \
              '{
                message: $message,
                content: $content,
                committer: {
                  name: "github-actions[bot]",
                  email: "41898282+github-actions[bot]@users.noreply.github.com"
                }
              }' > "$payload"
            http_out="$(gh api \
              --method PUT \
              "repos/${AUDIT_REPO}/contents/${dest_path}" \
              --input "$payload" \
              2>&1)" || {
                rm -f "$payload"
                if echo "$http_out" | grep -Eqi "already exists|HTTP/[0-9.]+ 422|sha wasn't supplied"; then
                  echo "Already exists: ${dest_path} — skipping."
                  return 0
                fi
                echo "ERROR uploading ${dest_path}: $http_out" >&2
                return 1
              }
            rm -f "$payload"
            echo "Persisted ${dest_path} to ${AUDIT_REPO}"
          }

          if [ -n "${HEAD_JSON:-}" ]; then
            upload_file \
              "${GITHUB_WORKSPACE}/${HEAD_JSON}" \
              "audit/pr/${PR_NUMBER}/${SHA}.json" \
              "perf(audit): pr#${PR_NUMBER} ${SHA}"
            ADDED=1
          fi

          if [ -n "${HEAD_CODEPATH_JSON:-}" ]; then
            SHOULD_COPY=1
            if [ -n "${HEAD_JSON:-}" ] && cmp -s "${GITHUB_WORKSPACE}/${HEAD_CODEPATH_JSON}" "${GITHUB_WORKSPACE}/${HEAD_JSON}"; then
              SHOULD_COPY=0
            fi
            if [ "$SHOULD_COPY" -eq 1 ]; then
              upload_file \
                "${GITHUB_WORKSPACE}/${HEAD_CODEPATH_JSON}" \
                "audit/pr/${PR_NUMBER}/${SHA}-codepath.json" \
                "perf(audit): pr#${PR_NUMBER} ${SHA} codepath"
              ADDED=1
            fi
          fi

          if [ "$ADDED" -eq 0 ]; then
            echo "No new perf JSON files to persist."
          fi
