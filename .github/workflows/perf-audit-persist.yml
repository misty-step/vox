name: 'Perf: Persist PR Audit'

on:
  workflow_run:
    workflows: ['Perf: Audit']
    types: [completed]

env:
  PERF_AUDIT_REPO: misty-step/vox-perf-audit

jobs:
  persist:
    name: Persist PR Perf JSON
    if: github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Persist To vox-perf-audit
        env:
          GH_TOKEN: ${{ secrets.PERF_AUDIT_TOKEN }}
          SOURCE_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "PERF_AUDIT_TOKEN not set; skipping persist to vox-perf-audit."
            exit 0
          fi

          bash scripts/perf/backfill-perf-audit.sh \
            --source-repo "${SOURCE_REPO}" \
            --audit-repo "${PERF_AUDIT_REPO}" \
            --run-id "${{ github.event.workflow_run.id }}" \
            --require-pr
