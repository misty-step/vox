name: 'Perf: Persist PR Audit'

on:
  workflow_run:
    workflows: ['Perf: Audit']
    types: [completed]

jobs:
  persist:
    name: Persist PR Perf JSON
    if: github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Perf Artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RUN_ID="${{ github.event.workflow_run.id }}"

          ART_ID="$(gh api \
            "repos/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}/artifacts" \
            --jq '.artifacts[] | select(.name | startswith("perf-audit-pr-")) | .id' \
            2>/dev/null | head -1 || true)"

          if [ -z "$ART_ID" ]; then
            echo "No perf-audit-pr-* artifact found."
            exit 0
          fi

          gh api "repos/${GITHUB_REPOSITORY}/actions/artifacts/${ART_ID}/zip" > artifact.zip
          unzip -q artifact.zip -d artifact

          HEAD_JSON="$(find artifact -name head.json | head -1 || true)"
          HEAD_CODEPATH_JSON="$(find artifact -name head-codepath.json | head -1 || true)"
          META_JSON="${HEAD_JSON:-$HEAD_CODEPATH_JSON}"

          if [ -z "$META_JSON" ]; then
            echo "No perf head JSON in artifact (audit likely skipped)."
            exit 0
          fi

          echo "HEAD_JSON=$HEAD_JSON" >> "$GITHUB_ENV"
          echo "HEAD_CODEPATH_JSON=$HEAD_CODEPATH_JSON" >> "$GITHUB_ENV"
          echo "META_JSON=$META_JSON" >> "$GITHUB_ENV"

      - name: Persist To vox-perf-audit
        env:
          GH_TOKEN: ${{ secrets.PERF_AUDIT_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${META_JSON:-}" ]; then
            echo "META_JSON unset; skipping."
            exit 0
          fi

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "PERF_AUDIT_TOKEN not set; skipping persist to vox-perf-audit."
            exit 0
          fi

          python3 - > meta.env <<'PY'
          import json, os, re, sys
          path = os.environ["META_JSON"]
          data = json.load(open(path, "r", encoding="utf-8"))
          pr = data.get("pullRequestNumber")
          sha = data.get("commitSHA")
          if pr is None or not sha:
            sys.exit(0)
          if isinstance(pr, int):
            pr_str = str(pr)
          elif isinstance(pr, str) and re.fullmatch(r"[0-9]+", pr):
            pr_str = pr
          else:
            sys.exit(0)
          if not isinstance(sha, str) or not re.fullmatch(r"[0-9a-fA-F]{40}", sha):
            sys.exit(0)
          print(f"PR_NUMBER={pr_str}")
          print(f"SHA={sha.lower()}")
          PY

          source meta.env
          if [ -z "${PR_NUMBER:-}" ] || [ -z "${SHA:-}" ]; then
            echo "Missing PR_NUMBER/SHA in head.json; skipping."
            exit 0
          fi
          if ! printf '%s' "$PR_NUMBER" | grep -Eq '^[0-9]+$'; then
            echo "Invalid PR_NUMBER in head.json; skipping."
            exit 0
          fi
          if ! printf '%s' "$SHA" | grep -Eq '^[0-9a-f]{40}$'; then
            echo "Invalid SHA in head.json; skipping."
            exit 0
          fi

          AUDIT_REPO="misty-step/vox-perf-audit"
          ADDED=0

          upload_file() {
            local src="$1"
            local dest_path="$2"
            local msg="$3"
            local content http_out
            content="$(base64 < "$src" | tr -d '\n')"
            http_out="$(gh api \
              --method PUT \
              "repos/${AUDIT_REPO}/contents/${dest_path}" \
              --field "message=${msg}" \
              --field "content=${content}" \
              --field "committer[name]=github-actions[bot]" \
              --field "committer[email]=41898282+github-actions[bot]@users.noreply.github.com" \
              2>&1)" || {
                if echo "$http_out" | grep -q "already exists"; then
                  echo "Already exists: ${dest_path} â€” skipping."
                  return 0
                fi
                echo "ERROR uploading ${dest_path}: $http_out" >&2
                return 1
              }
            echo "Persisted ${dest_path} to ${AUDIT_REPO}"
          }

          if [ -n "${HEAD_JSON:-}" ]; then
            upload_file \
              "${GITHUB_WORKSPACE}/${HEAD_JSON}" \
              "audit/pr/${PR_NUMBER}/${SHA}.json" \
              "perf(audit): pr#${PR_NUMBER} ${SHA}"
            ADDED=1
          fi

          if [ -n "${HEAD_CODEPATH_JSON:-}" ]; then
            SHOULD_COPY=1
            if [ -n "${HEAD_JSON:-}" ] && cmp -s "${GITHUB_WORKSPACE}/${HEAD_CODEPATH_JSON}" "${GITHUB_WORKSPACE}/${HEAD_JSON}"; then
              SHOULD_COPY=0
            fi
            if [ "$SHOULD_COPY" -eq 1 ]; then
              upload_file \
                "${GITHUB_WORKSPACE}/${HEAD_CODEPATH_JSON}" \
                "audit/pr/${PR_NUMBER}/${SHA}-codepath.json" \
                "perf(audit): pr#${PR_NUMBER} ${SHA} codepath"
              ADDED=1
            fi
          fi

          if [ "$ADDED" -eq 0 ]; then
            echo "No new perf JSON files to persist."
          fi
