name: 'Perf: Audit'

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  pr:
    name: Perf Audit (PR Comment)
    if: github.event_name == 'pull_request'
    runs-on: macos-14
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Perf Audit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
        run: |
          set -euo pipefail

          OUT_DIR="perf-out"
          mkdir -p "$OUT_DIR"

          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          PROVIDER_HEAD="$OUT_DIR/head-provider.json"
          CODEPATH_HEAD="$OUT_DIR/head-codepath.json"
          PRIMARY_HEAD="$OUT_DIR/head.json"

          SHORT_FIXTURE="$OUT_DIR/fixture-short.caf"
          MEDIUM_FIXTURE="$OUT_DIR/fixture-medium.caf"
          bash scripts/perf/make-fixture-audio.sh --variant short "$SHORT_FIXTURE"
          bash scripts/perf/make-fixture-audio.sh --variant medium "$MEDIUM_FIXTURE"

          # Deterministic lane always runs (no external API dependence).
          swift run VoxPerfAudit \
            --lane codepath \
            --audio "$SHORT_FIXTURE" \
            --audio "$MEDIUM_FIXTURE" \
            --output "$CODEPATH_HEAD" \
            --iterations 5 \
            --warmup 1 \
            --commit "${GITHUB_SHA}" \
            --pr "$PR_NUMBER" \
            --label "ci-codepath"

          if [ -z "${OPENROUTER_API_KEY:-}" ] || { [ -z "${ELEVENLABS_API_KEY:-}" ] && [ -z "${DEEPGRAM_API_KEY:-}" ]; }; then
            echo "Provider lane skipped: missing OPENROUTER_API_KEY and/or STT API key in CI."
          else
            swift run VoxPerfAudit \
              --lane provider \
              --audio "$SHORT_FIXTURE" \
              --audio "$MEDIUM_FIXTURE" \
              --output "$PROVIDER_HEAD" \
              --iterations 5 \
              --warmup 1 \
              --commit "${GITHUB_SHA}" \
              --pr "$PR_NUMBER" \
              --label "ci-provider"
          fi

          if [ -f "$PROVIDER_HEAD" ]; then
            cp "$PROVIDER_HEAD" "$PRIMARY_HEAD"
          else
            cp "$CODEPATH_HEAD" "$PRIMARY_HEAD"
          fi

          HISTORY_DIR="$OUT_DIR/history/pr"
          mkdir -p "$HISTORY_DIR"
          BASE_JSON="$OUT_DIR/base.json"
          BASE_SHA_USED="$BASE_SHA"
          BASE_MODE="missing"

          # Optional baseline: pulled from perf-audit branch if present.
          git fetch origin perf-audit || true
          if git show-ref --verify --quiet refs/remotes/origin/perf-audit; then
            while IFS= read -r path; do
              [ -n "$path" ] || continue
              git show "origin/perf-audit:${path}" > "$HISTORY_DIR/$(basename "$path")" 2>/dev/null || true
            done < <(git ls-tree -r --name-only origin/perf-audit "audit/pr/${PR_NUMBER}" | head -n 80)

            if [ -f "$PROVIDER_HEAD" ]; then
              if git show "origin/perf-audit:audit/${BASE_SHA}.json" >"$BASE_JSON" 2>/dev/null; then
                BASE_SHA_USED="$BASE_SHA"
                BASE_MODE="exact"
              else
                while IFS= read -r candidate; do
                  [ -n "$candidate" ] || continue
                  if git show "origin/perf-audit:audit/${candidate}.json" >"$BASE_JSON" 2>/dev/null; then
                    BASE_SHA_USED="$candidate"
                    BASE_MODE="nearest_ancestor"
                    break
                  fi
                done < <(git rev-list --max-count=400 "$BASE_SHA")
              fi
            fi
          fi

          FORMAT_ARGS=(
            --head "$PRIMARY_HEAD"
            --head-sha "$GITHUB_SHA"
            --history-dir "$HISTORY_DIR"
            --requested-base-sha "$BASE_SHA"
            --base-sha "$BASE_SHA_USED"
            --base-mode "$BASE_MODE"
            --out "$OUT_DIR/report.md"
          )
          if [ -f "$CODEPATH_HEAD" ] && [ -f "$PROVIDER_HEAD" ]; then
            FORMAT_ARGS+=(--codepath-head "$CODEPATH_HEAD")
          fi
          if [ -f "$BASE_JSON" ]; then
            FORMAT_ARGS+=(--base "$BASE_JSON")
          fi

          python3 scripts/perf/format-perf-report.py "${FORMAT_ARGS[@]}"

          bash scripts/perf/post-pr-comment.sh "$PR_NUMBER" "$OUT_DIR/report.md"

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-audit-pr-${{ github.run_number }}
          path: perf-out/
          retention-days: 30

  master:
    name: Perf Audit (Persist Baseline)
    if: github.event_name == 'push'
    runs-on: macos-14
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Run Audit
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
        run: |
          set -euo pipefail

          OUT_DIR="perf-out"
          mkdir -p "$OUT_DIR"

          if [ -z "${OPENROUTER_API_KEY:-}" ] || { [ -z "${ELEVENLABS_API_KEY:-}" ] && [ -z "${DEEPGRAM_API_KEY:-}" ]; }; then
            echo "Perf audit skipped: missing OPENROUTER_API_KEY and/or STT API key."
            exit 0
          fi

          SHORT_FIXTURE="$OUT_DIR/fixture-short.caf"
          MEDIUM_FIXTURE="$OUT_DIR/fixture-medium.caf"
          bash scripts/perf/make-fixture-audio.sh --variant short "$SHORT_FIXTURE"
          bash scripts/perf/make-fixture-audio.sh --variant medium "$MEDIUM_FIXTURE"

          swift run VoxPerfAudit \
            --lane provider \
            --audio "$SHORT_FIXTURE" \
            --audio "$MEDIUM_FIXTURE" \
            --output "$OUT_DIR/head.json" \
            --iterations 10 \
            --warmup 1 \
            --commit "${GITHUB_SHA}" \
            --label "ci-master-provider"

          swift run VoxPerfAudit \
            --lane codepath \
            --audio "$SHORT_FIXTURE" \
            --audio "$MEDIUM_FIXTURE" \
            --output "$OUT_DIR/head-codepath.json" \
            --iterations 10 \
            --warmup 1 \
            --commit "${GITHUB_SHA}" \
            --label "ci-master-codepath"

      - name: Persist To perf-audit Branch
        if: always() && hashFiles('perf-out/head.json') != ''
        run: |
          set -euo pipefail

          SHA="${GITHUB_SHA}"

          git fetch origin perf-audit || true

          WORKTREE_DIR="$(mktemp -d "${TMPDIR:-/tmp}/vox-perf-audit.XXXXXX")"
          if git show-ref --verify --quiet refs/remotes/origin/perf-audit; then
            git worktree add "$WORKTREE_DIR" origin/perf-audit
          else
            git worktree add "$WORKTREE_DIR" --detach
            cd "$WORKTREE_DIR"
            git checkout --orphan perf-audit
            git rm -rf . >/dev/null 2>&1 || true
          fi

          cd "$WORKTREE_DIR"
          mkdir -p audit
          cp "${GITHUB_WORKSPACE}/perf-out/head.json" "audit/${SHA}.json"

          git add "audit/${SHA}.json"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "perf(audit): ${SHA}" || exit 0
          git push origin HEAD:perf-audit

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-audit-master-${{ github.run_number }}
          path: perf-out/
          retention-days: 30
