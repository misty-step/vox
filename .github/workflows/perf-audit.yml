name: 'Perf: Audit'

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  pr:
    name: Perf Audit (PR Comment)
    if: github.event_name == 'pull_request'
    runs-on: macos-14
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Perf Audit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
        run: |
          set -euo pipefail

          OUT_DIR="perf-out"
          mkdir -p "$OUT_DIR"

          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          PROVIDER_HEAD="$OUT_DIR/head-provider.json"
          CODEPATH_HEAD="$OUT_DIR/head-codepath.json"
          PRIMARY_HEAD="$OUT_DIR/head.json"

          SHORT_FIXTURE="$OUT_DIR/fixture-short.caf"
          MEDIUM_FIXTURE="$OUT_DIR/fixture-medium.caf"
          bash scripts/perf/make-fixture-audio.sh --variant short "$SHORT_FIXTURE"
          bash scripts/perf/make-fixture-audio.sh --variant medium "$MEDIUM_FIXTURE"

          # Deterministic lane always runs (no external API dependence).
          swift run VoxPerfAudit \
            --lane codepath \
            --audio "$SHORT_FIXTURE" \
            --audio "$MEDIUM_FIXTURE" \
            --output "$CODEPATH_HEAD" \
            --iterations 5 \
            --warmup 1 \
            --commit "${GITHUB_SHA}" \
            --pr "$PR_NUMBER" \
            --label "ci-codepath"

          if [ -z "${OPENROUTER_API_KEY:-}" ] || { [ -z "${ELEVENLABS_API_KEY:-}" ] && [ -z "${DEEPGRAM_API_KEY:-}" ]; }; then
            echo "Provider lane skipped: missing OPENROUTER_API_KEY and/or STT API key in CI."
          else
            swift run VoxPerfAudit \
              --lane provider \
              --audio "$SHORT_FIXTURE" \
              --audio "$MEDIUM_FIXTURE" \
              --output "$PROVIDER_HEAD" \
              --iterations 5 \
              --warmup 1 \
              --commit "${GITHUB_SHA}" \
              --pr "$PR_NUMBER" \
              --label "ci-provider"
          fi

          if [ -f "$PROVIDER_HEAD" ]; then
            cp "$PROVIDER_HEAD" "$PRIMARY_HEAD"
          else
            cp "$CODEPATH_HEAD" "$PRIMARY_HEAD"
          fi

          # Combined history dir: per-PR runs + recent master baselines.
          # Both sources are needed so the trend spans actual project history,
          # not just the 2-3 commits in the current PR.
          HISTORY_DIR="$OUT_DIR/history"
          mkdir -p "$HISTORY_DIR"
          BASE_JSON="$OUT_DIR/base.json"
          BASE_SHA_USED="$BASE_SHA"
          BASE_MODE="missing"

          # Optional baseline: pulled from misty-step/vox-perf-audit (public, no token needed).
          AUDIT_REPO="misty-step/vox-perf-audit"

          # Fetch PR history artifacts for trend context.
          while IFS= read -r path; do
            [ -n "$path" ] || continue
            fname="$(basename "$path")"
            gh api "repos/${AUDIT_REPO}/contents/${path}" --jq '.content | @base64d' \
              > "$HISTORY_DIR/$fname" 2>/dev/null || rm -f "$HISTORY_DIR/$fname"
          done < <(
            gh api "repos/${AUDIT_REPO}/contents/audit/pr/${PR_NUMBER}" \
              --jq '.[].path' 2>/dev/null | head -n 80 || true
          )

          # Pre-fetch baseline SHA listing once via Git Trees API.
          # Query the audit subtree directly to avoid huge root-tree payloads.
          _AUDIT_DEFAULT="$(gh api "repos/${AUDIT_REPO}" --jq '.default_branch' 2>/dev/null || echo 'main')"
          _AUDIT_TREE_SHA="$(gh api "repos/${AUDIT_REPO}/git/trees/${_AUDIT_DEFAULT}" \
            --jq '.tree[] | select(.path=="audit" and .type=="tree") | .sha' 2>/dev/null | head -n 1 || true)"
          if [ -n "$_AUDIT_TREE_SHA" ]; then
            AVAILABLE_SHAS="$(gh api "repos/${AUDIT_REPO}/git/trees/${_AUDIT_TREE_SHA}?recursive=1" \
              --jq '[.tree[] | select(.path | test("^[^/]+\\.json$")) | .path | rtrimstr(".json")] | join("\n")' 2>/dev/null || true)"
          else
            AVAILABLE_SHAS="$(gh api "repos/${AUDIT_REPO}/git/trees/${_AUDIT_DEFAULT}?recursive=1" \
              --jq '[.tree[] | select(.path | test("^audit/[^/]+\\.json$")) | .path | ltrimstr("audit/") | rtrimstr(".json")] | join("\n")' 2>/dev/null || true)"
          fi

          # Master baseline history: last 15 master commits with persisted baselines.
          # Provides cross-PR trend context so the chart isn't reset each PR.
          # Uses git log for correct chronological ordering (SHA sort ≠ time order).
          if [ -n "$AVAILABLE_SHAS" ]; then
            _MASTER_COUNT=0
            while IFS= read -r sha; do
              [ -n "$sha" ] || continue
              if printf '%s\n' "$AVAILABLE_SHAS" | grep -qxF "$sha"; then
                gh api "repos/${AUDIT_REPO}/contents/audit/${sha}.json" --jq '.content | @base64d' \
                  > "$HISTORY_DIR/master-${sha}.json" 2>/dev/null \
                  || rm -f "$HISTORY_DIR/master-${sha}.json"
                _MASTER_COUNT=$((_MASTER_COUNT + 1))
                [ "$_MASTER_COUNT" -ge 15 ] && break
              fi
            done < <(git log --first-parent origin/master --format="%H" 2>/dev/null | head -n 200 || true)
          fi

          if [ -f "$PROVIDER_HEAD" ]; then
            # Try exact base SHA first.
            if gh api "repos/${AUDIT_REPO}/contents/audit/${BASE_SHA}.json" \
                --jq '.content | @base64d' > "$BASE_JSON" 2>/dev/null && [ -s "$BASE_JSON" ]; then
              BASE_SHA_USED="$BASE_SHA"
              BASE_MODE="exact"
            else
              # Walk ancestry for nearest persisted ancestor.
              # Uses pre-fetched AVAILABLE_SHAS; 0 extra API calls for the intersection.
              while IFS= read -r candidate; do
                [ -n "$candidate" ] || continue
                if printf '%s\n' "$AVAILABLE_SHAS" | grep -qxF "$candidate"; then
                  if gh api "repos/${AUDIT_REPO}/contents/audit/${candidate}.json" \
                      --jq '.content | @base64d' > "$BASE_JSON" 2>/dev/null && [ -s "$BASE_JSON" ]; then
                    BASE_SHA_USED="$candidate"
                    BASE_MODE="nearest_ancestor"
                    break
                  fi
                fi
              done < <(git rev-list --max-count=400 "$BASE_SHA" 2>/dev/null || true)
            fi
          fi

          FORMAT_ARGS=(
            --head "$PRIMARY_HEAD"
            --head-sha "$GITHUB_SHA"
            --history-dir "$HISTORY_DIR"
            --requested-base-sha "$BASE_SHA"
            --base-sha "$BASE_SHA_USED"
            --base-mode "$BASE_MODE"
            --out "$OUT_DIR/report.md"
          )
          if [ -f "$CODEPATH_HEAD" ] && [ -f "$PROVIDER_HEAD" ]; then
            FORMAT_ARGS+=(--codepath-head "$CODEPATH_HEAD")
          fi
          if [ -s "$BASE_JSON" ]; then
            FORMAT_ARGS+=(--base "$BASE_JSON")
          fi

          python3 scripts/perf/format-perf-report.py "${FORMAT_ARGS[@]}"

          bash scripts/perf/post-pr-comment.sh "$PR_NUMBER" "$OUT_DIR/report.md"

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-audit-pr-${{ github.run_number }}
          path: perf-out/
          retention-days: 30

  master:
    name: Perf Audit (Persist Baseline)
    if: github.event_name == 'push'
    runs-on: macos-14
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Run Audit
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
        run: |
          set -euo pipefail

          OUT_DIR="perf-out"
          mkdir -p "$OUT_DIR"

          if [ -z "${OPENROUTER_API_KEY:-}" ] || { [ -z "${ELEVENLABS_API_KEY:-}" ] && [ -z "${DEEPGRAM_API_KEY:-}" ]; }; then
            echo "Perf audit skipped: missing OPENROUTER_API_KEY and/or STT API key."
            exit 0
          fi

          SHORT_FIXTURE="$OUT_DIR/fixture-short.caf"
          MEDIUM_FIXTURE="$OUT_DIR/fixture-medium.caf"
          bash scripts/perf/make-fixture-audio.sh --variant short "$SHORT_FIXTURE"
          bash scripts/perf/make-fixture-audio.sh --variant medium "$MEDIUM_FIXTURE"

          swift run VoxPerfAudit \
            --lane provider \
            --audio "$SHORT_FIXTURE" \
            --audio "$MEDIUM_FIXTURE" \
            --output "$OUT_DIR/head.json" \
            --iterations 10 \
            --warmup 1 \
            --commit "${GITHUB_SHA}" \
            --label "ci-master-provider"

          swift run VoxPerfAudit \
            --lane codepath \
            --audio "$SHORT_FIXTURE" \
            --audio "$MEDIUM_FIXTURE" \
            --output "$OUT_DIR/head-codepath.json" \
            --iterations 10 \
            --warmup 1 \
            --commit "${GITHUB_SHA}" \
            --label "ci-master-codepath"

      - name: Persist To vox-perf-audit
        if: always() && hashFiles('perf-out/head.json') != ''
        env:
          GH_TOKEN: ${{ secrets.PERF_AUDIT_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "PERF_AUDIT_TOKEN not set; skipping persist to vox-perf-audit."
            exit 0
          fi

          SHA="${GITHUB_SHA}"
          AUDIT_REPO="misty-step/vox-perf-audit"

          # base64 encode and upload via Contents API (create, idempotent on 422).
          CONTENT="$(base64 < perf-out/head.json | tr -d '\n')"
          if HTTP_OUT="$(gh api \
            --method PUT \
            "repos/${AUDIT_REPO}/contents/audit/${SHA}.json" \
            --field "message=perf(audit): ${SHA}" \
            --field "content=${CONTENT}" \
            --field "committer[name]=github-actions[bot]" \
            --field "committer[email]=41898282+github-actions[bot]@users.noreply.github.com" \
            2>&1)"; then
            echo "Persisted audit/${SHA}.json to ${AUDIT_REPO}"
          elif echo "$HTTP_OUT" | grep -q "already exists"; then
            echo "Already exists: audit/${SHA}.json — skipping."
          else
            echo "ERROR uploading audit/${SHA}.json: $HTTP_OUT" >&2
            exit 1
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-audit-master-${{ github.run_number }}
          path: perf-out/
          retention-days: 30
