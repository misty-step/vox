---
last_mapped: 2026-02-20T21:53:00Z
total_files: 116
total_tokens: 307766
---

# Codebase Map

> Auto-generated by Cartographer. Last mapped: 2026-02-20.

## System Overview

Vox is a macOS menu-bar dictation app. Press Option+Space to record audio, which is transcribed via cloud STT providers (ElevenLabs, Deepgram) with on-device Apple Speech as fallback, optionally rewritten by an LLM (Gemini, OpenRouter), then pasted into the active application. On macOS 26+ with Apple Intelligence, SpeechTranscriber and Foundation Models are tried first for fully on-device STT and rewriting. The app runs as a background accessory process (no Dock icon) with a floating HUD for recording/processing feedback.

Pure SwiftPM, zero external dependencies. macOS 14+, Swift 5.9, Xcode 16.2.

## Architecture

```
VoxApp (executable)
  └── VoxAppKit (library: session, pipeline, settings, DI assembly)
        ├── VoxMac (platform: audio, keychain, HUD, hotkeys, paste)
        │     └── VoxCore (protocols, errors, decorators, shared types)
        └── VoxProviders (STT clients, rewrite clients, streaming)
              └── VoxCore
```

Auxiliary targets: `VoxBenchmarks` (rewrite model bakeoff CLI), `VoxPerfAudit` + `VoxPerfAuditKit` (pipeline latency auditor CLI).

## Directory Structure

```
Sources/
  VoxCore/            Protocols, error types, STT decorators, quality gate
  VoxProviders/       ElevenLabs, Deepgram, Apple Speech, OpenRouter, Gemini clients
  VoxMac/             AudioRecorder, HUD, hotkeys, keychain, clipboard, encryption
  VoxAppKit/          VoxSession, DictationPipeline, PreferencesStore, StatusBar, Settings, Onboarding
  VoxApp/             main.swift (bootstrap only)
  VoxBenchmarks/      Rewrite model bakeoff CLI
  VoxPerfAudit/       Pipeline latency audit CLI
  VoxPerfAuditKit/    Perf audit config, provider plan, stats
Tests/
  VoxCoreTests/       Decorator tests, error classification, quality gate, multipart
  VoxProvidersTests/  Client request format, streaming protocol, file size limits
  VoxAppTests/        Session state machine, pipeline integration, benchmark SLO
  VoxPerfAuditKitTests/  Config parsing, provider plan, distribution math
scripts/              CI, dev launcher, benchmarks, eval runners, perf tooling
evals/                promptfoo eval framework: smoke, injection, polish datasets
docs/                 Architecture, ADRs, design exploration, performance bakeoffs
.github/workflows/    CI, eval-smoke, eval-nightly, perf-audit, cerberus, release
```

## Module Guide

### VoxCore

Foundation layer. No dependencies on other Vox modules.

| File | Purpose |
|------|---------|
| `Protocols.swift` | `STTProvider`, `StreamingSTTProvider`, `RewriteProvider`, `TextPaster`, `AudioRecording`, `EncryptedAudioRecording`, `AudioChunkStreaming`, `HUDDisplaying`, `DictationProcessing`, `TranscriptProcessing`, `PreferencesReading` |
| `Errors.swift` | All error types: `STTError` (`.isRetryable`, `.isFallbackEligible`, `.isTransientForHealthScoring`), `VoxError` (`emptyCapture`, `permissionDenied`, `pipelineTimeout`), `RewriteError`, `StreamingSTTError` |
| `TimeoutSTTProvider.swift` | Dynamic deadline: `baseTimeout + fileSizeMB * secondsPerMB` |
| `RetryingSTTProvider.swift` | Exponential backoff + jitter on `STTError.isRetryable`; catch-all for non-STTError |
| `FallbackSTTProvider.swift` | Sequential primary → fallback on `.isFallbackEligible`; catch-all for non-STTError |
| `HedgedSTTProvider.swift` | Parallel race with stagger delays (opt-in via `VOX_STT_ROUTING=hedged`) |
| `ConcurrencyLimitedSTTProvider.swift` | Async semaphore bounding in-flight STT calls (global shared limit) |
| `HealthAwareSTTProvider.swift` | Rolling-window health monitoring; retained for adaptive routing |
| `RewriteQualityGate.swift` | Levenshtein + content overlap scoring; eval/benchmark use only (removed from production #284) |
| `ProcessingLevel.swift` | `.raw`, `.clean`, `.polish` with default model IDs — single source for model rollback |
| `SessionExtension.swift` | Lifecycle hooks: `authorizeRecordingStart`, `didCompleteDictation`, `didFailDictation` |
| `MultipartFormData.swift` | In-memory builder + file-streaming builder (64KB chunks, no full-file memory load) |
| `SecureFileDeleter.swift` | Swallows "file not found"; relies on FileVault for data-at-rest |
| `FallbackRewriteProvider.swift` | Sequential fallback across `RewriteProvider` implementations |
| `ModelRoutedRewriteProvider.swift` | Routes to Gemini direct or OpenRouter based on model ID prefix |
| `BrandIdentity.swift` | Accent color, icon dimensions, per-level stroke width |

### VoxProviders

STT and rewrite API clients. Depends only on VoxCore.

| File | Purpose |
|------|---------|
| `ElevenLabsClient.swift` | Batch STT via `/v1/speech-to-text` (multipart file upload) |
| `DeepgramClient.swift` | Batch STT via `/v1/listen` (raw body upload); CAF→WAV conversion injected |
| `AppleSpeechClient.swift` | On-device fallback via SFSpeechRecognizer; `ContinuationGuard` for single-resume safety |
| `SpeechTranscriberClient.swift` | macOS 26+ on-device STT via `SpeechTranscriber` + `SpeechAnalyzer`; availability-gated |
| `AppleFoundationModelsClient.swift` | macOS 26+ on-device rewrite via Apple Foundation Models (system language model); availability-gated |
| `DeepgramStreamingClient.swift` | WebSocket streaming STT; accumulates `is_final` segments |
| `ElevenLabsStreamingClient.swift` | WebSocket streaming STT; base64 JSON chunks; `commitSent` flag for auto-commit distinction |
| `OpenRouterClient.swift` | LLM rewrite via `/v1/chat/completions`; fallback model chain; reasoning disabled |
| `GeminiClient.swift` | LLM rewrite via Gemini `generateContent` API directly; 15s timeout |
| `AudioConverter.swift` | `afconvert` wrapper for CAF→Opus and CAF→WAV; async `terminationHandler` |
| `RewritePrompts.swift` | System prompts per processing level; includes prompt-injection defenses |
| `StreamingFinalizationTimeoutPolicy.swift` | Dynamic finalization timeout scaled by streamed audio duration |
| `URLSession+PhaseAwareSTTTimeout.swift` | Two-phase stall detection: upload stall vs processing hang |

### VoxMac

macOS platform integrations. Depends only on VoxCore.

| File | Purpose |
|------|---------|
| `AudioRecorder.swift` | AVAudioEngine (default) or AVAudioRecorder backend; 16kHz/16-bit mono CAF; streaming chunks; per-recording AES-GCM encryption |
| `AudioEncoder.swift` | CAF→Opus-in-CAF encoding for smaller uploads (uses CAF container, not Ogg) |
| `AudioDeviceManager.swift` | CoreAudio enumeration, default device management, `AudioDeviceObserver` with debounced change notification |
| `AudioFileEncryption.swift` | AES-GCM streaming encrypt/decrypt; `VOXENC1` format; 64KB chunks; key zeroization |
| `CapturedAudioInspector.swift` | Pre-pipeline audio integrity: decode first 512 frames, reject empty/corrupt |
| `ClipboardPaster.swift` | Clipboard write + simulated Cmd+V; AXIsProcessTrusted guard; clipboard snapshot/restore |
| `HotkeyMonitor.swift` | Carbon global hotkey registration |
| `HUDController.swift` | `NSPanel` lifecycle, position persistence, accessibility announcements |
| `HUDView.swift` | SwiftUI HUD: idle/recording/processing/success states; 30fps animation; EMA-smoothed audio levels |
| `HUDAccessibility.swift` | VoiceOver labels, announcements, `HUDAnnouncementPolicy` dedup |
| `KeychainHelper.swift` | Keychain CRUD for API keys; `kSecAttrAccessibleWhenUnlocked` |
| `PermissionManager.swift` | Microphone and accessibility TCC permission handling |
| `SystemSettingsLink.swift` | Deep-links to System Settings privacy panes |

### VoxAppKit

App orchestration. Depends on VoxCore, VoxProviders, VoxMac.

| File | Purpose |
|------|---------|
| `AppDelegate.swift` | Root coordinator: wires session, status bar, settings, onboarding, hotkey, diagnostics |
| `VoxSession.swift` | State machine (idle→recording→processing→idle); streaming vs batch routing; DI boundary |
| `DictationPipeline.swift` | audio → encode → STT → rewrite → paste; 120s pipeline timeout; timing instrumentation |
| `PreferencesStore.swift` | UserDefaults (level, device) + Keychain (API keys); `PreferencesReading` protocol |
| `DiagnosticsStore.swift` | Append-only JSONL event log; 512KB rotation; zip export; forwards `pipeline_timing` to perf ingest |
| `PerformanceIngestClient.swift` | Best-effort HTTP upload of timing events; 2s/64KB flush; `pipeline_timing` allowlist only |
| `LastDictationRecoveryStore.swift` | In-memory TTL (10min) store for raw transcript + final text; powers retry/copy actions |
| `RewriteResultCache.swift` | LRU+TTL rewrite cache (128 entries, 600s, 1024-char max); keyed by transcript+level+model |
| `StatusBarController.swift` | Menu bar item, menu construction, icon rendering, all menu actions |
| `SettingsWindowController.swift` | NSHostingController wrapper for SwiftUI settings |
| `Settings/*.swift` | SwiftUI views: basics, cloud keys sheet, provider catalog, product footer; `HotkeyState` shared observable for hotkey availability |
| `Onboarding/*.swift` | Setup checklist with live permission/key status |
| `ProductInfo.swift` | Version/build resolution from Bundle → env vars → fallbacks |

## Data Flow

### Recording → Transcription → Paste

```
Option+Space
  │
  ▼
VoxSession.toggleRecording()
  │  idle → recording
  │  Sets selected input device as system default
  │
  ▼
AudioRecorder.start()
  │  Generates per-recording AES-GCM key
  │  Installs tap on AVAudioEngine.inputNode
  │  Converts hardware format → 16kHz/Int16/mono via AVAudioConverter
  │  Writes frames to CAF via AVAudioFile
  │  Emits AudioChunks to StreamingAudioBridge (if streaming enabled)
  │
  ▼  (user releases key)
AudioRecorder.stop()
  │  Flushes converter (.endOfStream)
  │  Encrypts CAF → .enc via AES-GCM
  │  Deletes plaintext CAF
  │
  ▼
VoxSession: recording → processing
  │
  ├─► [Streaming path] StreamingAudioBridge.finish()
  │   │  WebSocket transcript from Deepgram/ElevenLabs
  │   │  On failure: falls back to batch path
  │   │
  │   └─► DictationPipeline.process(rawTranscript:)
  │
  └─► [Batch path] Decrypt .enc → temp CAF
      │
      ▼
      DictationPipeline.process(audioURL:)
        │  CapturedAudioInspector validates frames
        │  Optional Opus encoding (≥200KB)
        │  STT chain (120s timeout): ElevenLabs → Deepgram → Apple Speech
        │  Optional LLM rewrite (clean: 15s, polish: 30s timeout)
        │  Fallback to raw transcript on rewrite failure/timeout
        │  ClipboardPaster inserts text
        │
        ▼
      DiagnosticsStore.record("pipeline_timing")
        → PerformanceIngestClient (if VOX_PERF_INGEST_URL set)
```

### STT Decorator Stack (Default Production Path)

```
ConcurrencyLimitedSTTProvider (max 8)
  └── FallbackSTTProvider (sequential)
        ├── primary: FallbackSTTProvider
        │     ├── ElevenLabs(Timeout → Retry)
        │     └── Deepgram(Timeout → Retry)
        └── fallback: appleSTT (see below)

appleSTT (macOS 26+):
  FallbackSTTProvider(SpeechTranscriberClient → AppleSpeechClient)

appleSTT (macOS < 26):
  AppleSpeechClient
```

### Rewrite Provider Routing

```
macOS 26+ with Apple Intelligence:
  FallbackRewriteProvider
    ├── AppleFoundationModelsClient (on-device, zero-key)
    └── cloud chain (below)

Cloud chain (all macOS versions):
  ModelRoutedRewriteProvider
    ├── gemini-* model → GeminiClient (fallback: OpenRouterClient)
    └── other model    → OpenRouterClient (fallback: GeminiClient with fallbackGeminiModel)
```

## Environment Variables

| Variable | Default | Effect |
|----------|---------|--------|
| `VOX_AUDIO_BACKEND` | (unset=engine) | `recorder` opts into legacy AVAudioRecorder |
| `VOX_DISABLE_STREAMING_STT` | (unset) | `1` forces batch-only STT |
| `VOX_STT_ROUTING` | (unset=sequential) | `hedged` enables parallel cloud race |
| `VOX_MAX_CONCURRENT_STT` | `8` | Concurrency limit for in-flight STT calls |
| `VOX_ENABLE_PER_APP_AUDIO_ROUTING` | (unset) | `1` enables per-app audio device routing |
| `VOX_PERF_INGEST_URL` | (unset) | HTTP endpoint for pipeline timing upload |
| `VOX_PERF_STT_PROVIDER` | `auto` | `elevenlabs` or `deepgram` to force in perf audit |
| `ELEVENLABS_API_KEY` | — | ElevenLabs STT (env → Keychain) |
| `DEEPGRAM_API_KEY` | — | Deepgram STT + streaming (env → Keychain) |
| `OPENROUTER_API_KEY` | — | OpenRouter rewrite (env → Keychain) |
| `GEMINI_API_KEY` | — | Gemini direct rewrite (env → Keychain) |

## CI/CD Pipelines

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `ci.yml` | Push/PR to master | Lint → build → audio guardrails → tests → benchmark (PRs) |
| `cerberus.yml` | PR opened/sync | 5 parallel AI reviewers → council verdict |
| `eval-smoke.yml` | PR touching prompts/evals | promptfoo smoke eval → PR comment |
| `eval-nightly.yml` | Weekday 06:00 UTC | Full eval suite (smoke + injection) |
| `perf-audit.yml` | PR + push to master | Pipeline latency audit → baseline comparison → PR comment |
| `perf-audit-persist.yml` | After perf-audit on PR | Persists timing to `perf-audit` branch |
| `release.yml` | After CI on master | Landfall semantic-release |
| `macos-release.yml` | Manual dispatch | Signed + notarized `.app` bundle |

## Conventions

- **Commits**: Conventional Commits with scoped prefixes
- **Branches**: `feat/`, `fix/`, `refactor/`, `docs/`
- **Logging**: Bracket tags — `[ElevenLabs]`, `[STT]`, `[Pipeline]`, `[Vox]`, `[AudioRecorder]`
- **Security**: No transcript content in logs (char counts only); debug logs gated behind `#if DEBUG`
- **Thread safety**: `NSLock` + `@unchecked Sendable` for cross-actor state; `ContinuationGuard` for single-resume
- **DI pattern**: nil-defaulted constructor params → resolve in body (sidesteps `@MainActor` default expr limitation)
- **Test naming**: `test_methodName_behaviorWhenCondition` (XCTest) or `@Test("Natural sentence")` (Swift Testing)

## Navigation Guide

**To add a new STT provider**: Create client in `Sources/VoxProviders/`, conform to `STTProvider`, add to `VoxSession.makeSTTProvider()` chain, add tests in `Tests/VoxProvidersTests/`.

**To add a new STT decorator**: Create in `Sources/VoxCore/`, conform to `STTProvider`, wrap inner provider. Add tests in `Tests/VoxCoreTests/`.

**To modify audio recording**: Edit `Sources/VoxMac/AudioRecorder.swift`. Must pass all 6 audio guardrail test suites (`scripts/test-audio-guardrails.sh`).

**To add a new rewrite provider**: Create client in `Sources/VoxProviders/`, conform to `RewriteProvider`, update `ModelRoutedRewriteProvider` or `FallbackRewriteProvider`, update `VoxSession.makeRewriteProvider()`.

**To add availability-gated providers (macOS 26+)**: Use `#if canImport(FoundationModels)` as SDK proxy + `@available(macOS 26.0, *)`. See `SpeechTranscriberClient.swift` and `AppleFoundationModelsClient.swift` for the pattern. Wire in `VoxSession` with `#if canImport` + `#available` double-gate.

**To change processing levels**: Edit `Sources/VoxCore/ProcessingLevel.swift` (model IDs), `Sources/VoxProviders/RewritePrompts.swift` (system prompts), run eval suite.

**To add a settings control**: Edit `Sources/VoxAppKit/Settings/`, back with `PreferencesStore`. Check [ADR-0001](docs/adr/0001-simplicity-first-design.md) simplicity gate.

**To add a menu bar action**: Edit `Sources/VoxAppKit/StatusBarController.swift` (`rebuildMenu()`).

**To modify the eval framework**: Edit `evals/datasets/`, `evals/promptfooconfig.yaml`, run `evals/scripts/eval-smoke.sh` locally.

**To add diagnostics events**: Call `DiagnosticsStore.recordAsync(name:sessionID:fields:)` — fire-and-forget. Only `pipeline_timing` events forward to perf ingest.
