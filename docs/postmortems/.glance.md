## Purpose
This directory contains blameless writeups for production-impacting regressions and incidents. These documents detail technical root causes, impact scope, and the specific architectural changes implemented to prevent recurrence. The primary goal is to provide a factual record of system failures and the resulting hardening of the audio capture and processing pipelines.

## Key Roles
- **README.md**: Serves as the index for all documented postmortems within the directory.
- **2026-02-08-audio-capture-underflow.md**: Details a specific regression where the migration to `AVAudioEngine` caused zero-byte audio captures, documenting the fix that restored `AVAudioRecorder` as the default backend and introduced payload validation guards.

## Dependencies and Caveats
- **Backend Selection**: `AVAudioRecorder` is the default capture backend for reliability; `AVAudioEngine` is an opt-in path triggered by the `VOX_AUDIO_BACKEND=engine` environment variable.
- **Payload Validation**: The `CapturedAudioInspector` module is required to identify and reject header-only CAF files (`VoxError.emptyCapture`) before they reach the STT stage.
- **Pipeline Invariants**: The `DictationPipeline` must fall back to the original CAF file if Opus encoding results in an empty payload.
- **Thread Safety**: `AudioRecorder` utilizes lock-protected converter state to prevent races during the stop/flush sequence.
- **Route Sensitivity**: `AVAudioEngine` capture reliability is noted to be sensitive to specific hardware routes, particularly Bluetooth and default-route combinations.
- **Detection Limitations**: Automated CI may lack the behavioral contracts necessary to detect zero-frame payloads, requiring manual inspection of recovery artifacts via tools like `afinfo`.
- **Module Boundaries**: The `AudioRecorder` interface is designed to hide backend complexity, exposing a stable interface regardless of whether `AVAudioEngine` or `AVAudioRecorder` is active.