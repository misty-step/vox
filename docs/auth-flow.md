# Vox Authentication Flow

This document describes all components required for the sign-in flow to work end-to-end.

## Overview

Vox uses a web-based OAuth flow with deep link callback:

1. User clicks "Sign In" in paywall
2. Browser opens gateway auth URL
3. User authenticates via Clerk
4. Gateway redirects to `vox://auth?token=...`
5. macOS routes deep link to Vox app
6. App stores token and validates entitlement

## Required Components

### 1. Info.plist URL Scheme Registration

The app must register the `vox://` URL scheme in Info.plist:

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLName</key>
        <string>com.vox.app</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>vox</string>
        </array>
    </dict>
</array>
```

**Location:** Generated by `scripts/build-dmg.sh` (lines 52-62)

**Verification:** Run `scripts/verify-plist.sh` after building

### 2. AppDelegate Deep Link Handler

File: `Sources/VoxApp/AppDelegate.swift`

The `application(_:open:)` method handles incoming `vox://` URLs:

```swift
func application(_ application: NSApplication, open urls: [URL]) {
    for url in urls {
        handleDeepLink(url)
    }
}
```

### 3. AuthManager Token Storage

File: `Sources/VoxApp/Auth/AuthManager.swift`

Receives token from deep link, stores in Keychain via `KeychainHelper`.

### 4. Gateway Auth Endpoint

The gateway (`apps/gateway`) provides:
- `/api/auth/signin` - Initiates Clerk auth
- Redirect URL configured to `vox://auth?token=...`

### 5. Entitlement Validation

After token storage, `EntitlementManager` polls the gateway to validate subscription status.

## Testing the Flow

### Automated
```bash
./scripts/verify-plist.sh  # Verify URL scheme registered
swift test                  # Run unit tests
```

### Manual (Required Before Release)
```bash
./scripts/smoke-test.sh    # Follow checklist
```

## Common Issues

### Sign-In Button Does Nothing
**Cause:** URL scheme not registered in built app
**Fix:** Rebuild with `./scripts/build-dmg.sh`, verify with `./scripts/verify-plist.sh`

### Token Not Received After Web Auth
**Cause:** Deep link handler not invoked
**Debug:** Check Console.app for `vox://` URL routing errors

### Entitlement Not Updating
**Cause:** Token not stored or gateway unreachable
**Debug:** Check `AuthManager` logs, verify `VOX_GATEWAY_URL` env var
