## Purpose
This directory contains unit and integration tests for audio transcription (STT) and text rewriting providers. It verifies the integration with external APIs including Deepgram, ElevenLabs, Gemini, and OpenRouter, as well as local macOS transcription services. The tests ensure correct request formatting, error mapping, streaming session management, and fallback logic across different provider implementations.

## Key Roles
- **DeepgramClientTests.swift & DeepgramStreamingClientTests.swift**: Validate REST and WebSocket-based transcription, including chunked audio delivery, metadata handling, and OGG/CAF content type management.
- **ElevenLabsClientTests.swift & ElevenLabsStreamingClientTests.swift**: Test speech-to-text functionality, focusing on multipart data handling and the accumulation of partial versus committed transcripts.
- **GeminiClientTests.swift & OpenRouterClientTests.swift**: Verify text rewriting logic, including system instruction formatting, provider routing preferences, and fallback chain execution.
- **ProviderAssemblyTests.swift**: Tests the centralized builder logic for instantiating provider chains, verifying retry constants and instrumentation hooks.
- **AudioConverterTests.swift**: Ensures Opus conversion availability and validates that CAF to Opus conversion results in smaller file sizes.
- **SpeechTranscriberClientTests.swift**: Validates local on-device transcription gating and file validation for supported macOS versions.
- **URLProtocolStub.swift**: Provides shared infrastructure for intercepting and stubbing network requests across the test suite.

## Dependencies and Caveats
- Uses `AVFoundation` for audio buffer generation, format handling, and file validation.
- `DeepgramClientTests` utilizes an external `ffmpeg` binary located at `/opt/homebrew/bin/ffmpeg` to generate silent CAF files.
- `SpeechTranscriberClientTests` are restricted to environments supporting `macOS 26.0` or later.
- Certain integration tests require environment variables, such as `DEEPGRAM_API_KEY`, to execute live transcription calls.
- `OpenRouterClient` implements specific retry logic that relaxes routing parameters if a 404 "No endpoints found" error is encountered.
- Streaming tests employ mock WebSocket transports to simulate message sequences, including auto-commits and metadata signals.
- `PhaseAwareSTTTimeoutState` logic distinguishes between upload stall timeouts and post-upload processing timeouts.
- `AudioConverter` tests explicitly check for the `ogg` path extension and file size reduction during conversion.