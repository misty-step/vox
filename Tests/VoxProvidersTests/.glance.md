## Purpose
This directory contains the unit and integration test suite for the `VoxProviders` module. It validates the implementation of speech-to-text (STT) and text rewriting clients for services including Deepgram, ElevenLabs, Gemini, and OpenRouter. The tests ensure correct request formatting, response parsing, error handling, and streaming session lifecycle management. Additionally, it verifies internal utilities for audio conversion, provider assembly, and dynamic timeout logic.

## Key Roles
- `DeepgramClientTests.swift` / `ElevenLabsClientTests.swift`: Validate REST-based transcription, including HTTP error mapping and multipart MIME type handling.
- `DeepgramStreamingClientTests.swift` / `ElevenLabsStreamingClientTests.swift`: Verify WebSocket streaming session behavior, partial transcript accumulation, and finalization logic using mock transports.
- `GeminiClientTests.swift` / `OpenRouterClientTests.swift`: Test text rewriting providers, focusing on JSON payload structure, model routing, and fallback chains.
- `AudioConverterTests.swift` / `AudioConverterStaticTests.swift`: Confirm audio file conversion between CAF, WAV, and Opus formats, and validate system executable paths.
- `ProviderAssemblyTests.swift`: Tests the construction of provider fallback chains and the application of instrumentation hooks.
- `PhaseAwareSTTTimeoutStateTests.swift` / `BatchSTTTimeoutsTests.swift`: Validate logic for detecting upload stalls and scaling timeouts based on file size.
- `URLProtocolStub.swift`: Provides a shared utility for stubbing `URLSession` network requests and capturing request data.
- `SpeechTranscriberClientTests.swift`: Focuses on availability gating and API contract verification for system-level speech transcription.

## Dependencies and Caveats
- **AVFoundation**: Required for generating test audio buffers and validating audio formats like PCM16LE.
- **External Executables**: Certain tests depend on the presence of `/usr/bin/afconvert` and `/opt/homebrew/bin/ffmpeg` for audio processing and file generation.
- **Platform Gating**: `SpeechTranscriberClientTests` are conditionally compiled and require macOS 26.0 or later.
- **Environment Variables**: Integration tests for Deepgram require a `DEEPGRAM_API_KEY` environment variable or they are skipped.
- **Mocking**: Streaming tests use custom mock transport classes to simulate asynchronous WebSocket messages and finalization signals.
- **Error Mapping**: Tests explicitly verify the mapping of HTTP status codes (401, 403, 429, 5xx) to domain-specific error types like `STTError` or `RewriteError`.
- **Test Frameworks**: Uses both the standard `XCTest` framework and the Swift `Testing` library.
- **Timeout Policies**: Validates both constant and scaled duration policies for streaming and batch processing phases.