## Purpose
This directory contains the test suite for the `VoxPipeline` module, focusing on the coordination of speech-to-text (STT) transcription, text rewriting, and pasting operations. The tests validate the `DictationPipeline` for functional correctness, concurrency safety, and diagnostic reporting. Additionally, the suite includes benchmarks to measure latency against specific Service Level Objectives (SLOs) and verifies supporting components like caching and recovery storage.

## Key Roles
- `DictationPipelineTests.swift`: Validates the primary processing flow, including audio validation, Opus conversion logic, and error fallback mechanisms.
- `PipelineBenchmarkTests.swift`: Measures stage-specific and total latency distributions (P50/P95) to ensure performance remains within defined budgets.
- `DictationPipelineDiagnosticsTests.swift`: Verifies that the pipeline emits correct diagnostic events for stage outcomes, cache hits, and conversion fallbacks.
- `DictationPipelineConcurrencyTests.swift`: Ensures thread-safety and proper `MainActor` usage when accessing preferences and processing detached tasks.
- `RewriteResultCacheTests.swift` & `LastDictationRecoveryStoreTests.swift`: Test state persistence, TTL-based expiration, and result caching for transcripts and rewrites.
- `RewritePromptsTests.swift`: Validates the content and formatting instructions of the system prompts used during the rewrite stage.

## Dependencies and Caveats
- **VoxCore & VoxPipeline**: The suite is tightly coupled with core abstractions including `STTProvider`, `RewriteProvider`, `TextPaster`, and `ProcessingLevel`.
- **Swift Testing Framework**: Uses the `Testing` library for suite organization and assertions.
- **AVFoundation**: Required for generating test audio artifacts (CAF format) and managing PCM buffers.
- **Benchmark Environment**: Latency tests only execute when the `VOX_RUN_BENCHMARK_TESTS` environment variable is set to "1".
- **Opus Conversion**: Pipeline logic includes conditional Opus conversion based on file size thresholds and provider availability.
- **Timeouts**: The pipeline implements stage-specific timeouts that trigger fallbacks to raw transcripts if the rewrite stage exceeds defined limits.
- **MainActor Constraints**: The `DictationPipeline` and its preference-reading components are designed for `MainActor` isolation.