## Purpose
The `Tests/VoxSessionTests` directory contains unit tests and mock implementations designed to validate the `VoxSession` component. Its primary focus is verifying dependency injection, recording state transitions, and the orchestration of batch and streaming speech-to-text (STT) processing. The tests ensure correct behavior for audio capture, encryption handling, and transcript recovery features.

## Key Roles
- **VoxSessionTests.swift**: The primary test file containing the `VoxSessionDITests` suite and multiple mock objects. It validates environment variable parsing, session extensions, microphone access logic, and error handling.
- **Mock Objects**: A collection of classes (e.g., `MockRecorder`, `MockPipeline`, `MockHUD`, `MockStreamingSession`) that simulate audio hardware, processing pipelines, and user interface displays to facilitate isolated testing of session logic.

## Dependencies and Caveats
- **Framework Dependencies**: Relies on `Foundation`, `Testing`, `VoxCore`, and `VoxPipeline`.
- **Internal Access**: Uses `@testable` imports for `VoxMac` and `VoxSession` to verify internal state and logic.
- **Concurrency**: Many mocks and tests are marked with `@MainActor` to handle UI-related synchronization and state changes.
- **Environment Configuration**: Tests explicitly verify parsing logic for environment variables including `VOX_DISABLE_STREAMING_STT`, `VOX_STT_ROUTING`, and `VOX_AUDIO_BACKEND`.
- **Security Logic**: Includes tests for `EncryptedAudioRecording` to ensure encryption keys are consumed or discarded correctly during batch and streaming fallbacks.
- **Streaming Mechanics**: Validates chunk drainage, buffering during slow session setup, and timeout handling for non-cooperative I/O operations.
- **Recovery Features**: Tests the `LastDictationRecoveryStore` for copying raw transcripts and retrying rewrites after processing failures.